name: Keep Supabase Database Active

on:
  schedule:
    # Run every 3 days at 2 AM UTC (adjust timezone as needed)
    - cron: '0 2 */3 * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  keep-alive:
    runs-on: ubuntu-latest
    steps:
      - name: Check Environment
        run: |
          echo "ğŸ” Checking environment..."
          echo "APP_URL is set: ${{ secrets.APP_URL != '' }}"
          echo "Current time: $(date)"

      - name: Ping Database
        run: |
          echo "ğŸš€ Pinging database to keep it active..."

          # Check if APP_URL is set
          if [ -z "${{ secrets.APP_URL }}" ]; then
            echo "âŒ APP_URL secret is not set in repository settings"
            echo "Please add APP_URL secret with your deployed application URL"
            exit 1
          fi

          echo "ğŸ“¡ Pinging: ${{ secrets.APP_URL }}/api/ping"

          # Make the request with more verbose output
          response=$(curl -s -w "%{http_code}" -o /tmp/response.json \
            -H "User-Agent: GitHub-Actions-KeepAlive/1.0" \
            -H "Accept: application/json" \
            --max-time 30 \
            "${{ secrets.APP_URL }}/api/ping")

          echo "ğŸ“Š HTTP Status Code: $response"
          echo "ğŸ“„ Response Body:"
          cat /tmp/response.json
          echo ""

          if [ "$response" = "200" ]; then
            echo "âœ… Database ping successful!"
            echo "ğŸ¯ Database is active and responding"
          else
            echo "âŒ Database ping failed with HTTP status: $response"
            echo "ğŸ”§ This might indicate:"
            echo "   - Application is not deployed or accessible"
            echo "   - APP_URL secret points to wrong URL"
            echo "   - Database connection issues"
            echo "   - API endpoint issues"
            exit 1
          fi

      - name: Log Result
        run: |
          echo "âœ¨ Keep-alive job completed successfully at $(date)"
          echo "ğŸ”„ Next run scheduled in 3 days"
